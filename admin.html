<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administraci贸n</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h2 class="mb-4">Panel de Administraci贸n</h2>
    <div id="usuarios-container" class="table-responsive"></div>
  </div>

  <script>
    const supabase = supabase.createClient(
      'https://brzsayjqohyhpssfgqct.supabase.co',
      'Markitho15'
    );

    async function verificarAcceso() {
      const { data: { user }, error: errorUser } = await supabase.auth.getUser();
      if (errorUser || !user) {
        alert('Debes iniciar sesi贸n');
        return window.location.href = 'login.html';
      }

      const { data: usuario, error: errorPerfil } = await supabase
        .from('usuarios')
        .select('rol')
        .eq('id', user.id)
        .single();

      if (errorPerfil || !usuario || usuario.rol !== 'admin') {
        alert('Acceso denegado');
        return window.location.href = 'login.html';
      }

      cargarUsuarios(); // solo si es admin
    }

    async function cargarUsuarios() {
      const { data: usuarios, error } = await supabase.from('usuarios').select('*');
      if (error) return alert('Error al cargar usuarios');

      const tabla = `
        <table class="table table-bordered table-hover">
          <thead class="table-dark">
            <tr>
              <th>Usuario</th>
              <th>Email</th>
              <th>Rol</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${usuarios.map(u => `
              <tr>
                <td>${u.nombre}</td>
                <td>${u.email}</td>
                <td>
                  <select class="form-select form-select-sm" onchange="cambiarRol('${u.id}', this.value)">
                    <option value="cliente" ${u.rol === 'cliente' ? 'selected' : ''}>Cliente</option>
                    <option value="distribuidor" ${u.rol === 'distribuidor' ? 'selected' : ''}>Distribuidor</option>
                    <option value="proveedor" ${u.rol === 'proveedor' ? 'selected' : ''}>Proveedor</option>
                    <option value="admin" ${u.rol === 'admin' ? 'selected' : ''}>Admin</option>
                  </select>
                </td>
                <td>${u.activo ? '<span class="badge bg-success">Aprobado</span>' : '<span class="badge bg-warning text-dark">Pendiente</span>'}</td>
                <td>
                  ${!u.activo ? `
                    <button class="btn btn-sm btn-success me-1" onclick="aprobar('${u.id}')">Aprobar</button>
                    <button class="btn btn-sm btn-danger" onclick="rechazar('${u.id}')">Rechazar</button>
                  ` : `
                    <button class="btn btn-sm btn-secondary" disabled>Aprobado</button>
                  `}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('usuarios-container').innerHTML = tabla;
    }

    async function aprobar(id) {
      const { error } = await supabase.from('usuarios').update({ activo: true }).eq('id', id);
      if (error) return alert('Error al aprobar usuario');
      cargarUsuarios();
    }

    async function rechazar(id) {
      const { error } = await supabase.from('usuarios').delete().eq('id', id);
      if (error) return alert('Error al eliminar usuario');
      cargarUsuarios();
    }

    async function cambiarRol(id, nuevoRol) {
      const { error } = await supabase.from('usuarios').update({ rol: nuevoRol }).eq('id', id);
      if (error) alert('Error al cambiar el rol');
    }

    verificarAcceso(); // Inicia el control de acceso al cargar
    
     async function cerrarSesion() {
      const { error } = await supabase.auth.signOut();
      if (error) {
        alert('Error al cerrar sesi贸n');
      } else {
        window.location.href = 'login.html?logout=1';
      }
    }

    verificarAcceso();
  </script>
</body>
</html>
