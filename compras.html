<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compra de Servicios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="container mt-5">
    <h2>Bienvenido</h2>
    <p id="creditos">Créditos disponibles: -</p>
    <div class="mb-3">
      <label for="servicioSelect" class="form-label">Elige un servicio:</label>
      <select id="servicioSelect" class="form-select" onchange="mostrarPrecio()"></select>
    </div>
    <p id="precioServicio">Precio: -</p>
    <div class="mt-3">
      <button class="btn btn-success me-2" onclick="recargar(event)">Recargar 10 créditos</button>
      <button class="btn btn-primary" onclick="comprar(event)">Comprar servicio</button>
    </div>
  </div>

  <script>
    const supabase = supabase.createClient(
      'https://brzsayjqohyhpssfgqct.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyenNheWpxb2h5aHBzc2ZncWN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwMTU5MzYsImV4cCI6MjA2MDU5MTkzNn0.4JNO1yeUcuSnJXOMN_bZRlugDQZFbkyqYgWyQYkUFF8'
    );

    let servicios = [];

    async function verificarSesion() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = 'login.html';
      } else {
        cargarServicios();
        obtenerCreditos();
      }
    }

    async function cargarServicios() {
      const { data, error } = await supabase.from('servicios').select('*');
      if (error) return alert('Error al cargar servicios');
      servicios = data;
      const select = document.getElementById('servicioSelect');
      data.forEach(servicio => {
        const option = document.createElement('option');
        option.value = servicio.id;
        option.textContent = servicio.nombre;
        select.appendChild(option);
      });
    }

    function mostrarPrecio() {
      const selectedId = document.getElementById('servicioSelect').value;
      const servicio = servicios.find(s => s.id == selectedId);
      document.getElementById('precioServicio').innerText = `Precio: ${servicio?.precio ?? '-'} créditos`;
    }

    async function obtenerCreditos() {
      const { data: { user } } = await supabase.auth.getUser();
      const { data, error } = await supabase.from('usuarios').select('creditos').eq('id', user.id).single();
      if (!error) document.getElementById('creditos').innerText = `Créditos disponibles: ${data.creditos}`;
    }

    async function recargar(event) {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Recargando...';
      const { data: { user } } = await supabase.auth.getUser();
      await supabase.from('recargas').insert([{ usuario_id: user.id, cantidad: 10 }]);
      await obtenerCreditos();
      btn.disabled = false;
      btn.textContent = 'Recargar 10 créditos';
    }

    async function comprar(event) {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Comprando...';

      const { data: { user } } = await supabase.auth.getUser();
      const servicioId = document.getElementById('servicioSelect').value;
      const servicio = servicios.find(s => s.id == servicioId);
      const { data: usuario } = await supabase.from('usuarios').select('creditos').eq('id', user.id).single();

      if (usuario.creditos < servicio.precio) {
        alert('No tienes créditos suficientes.');
        btn.disabled = false;
        btn.textContent = 'Comprar servicio';
        return;
      }

      await supabase.from('compras').insert([{ cliente_id: user.id, servicio_id: servicioId }]);
      alert('¡Compra realizada!');
      await obtenerCreditos();

      btn.disabled = false;
      btn.textContent = 'Comprar servicio';
    }

    verificarSesion();
  </script>
</body>
</html>
