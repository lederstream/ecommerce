<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cinebestial | Servicios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="mb-4 text-center">Servicios Disponibles</h1>
    <div id="servicios-container" class="row g-4"></div>
  </div>

  <!-- Primero la librería de Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <!-- Luego tu propio script, después de la librería -->
  <script>
    const supabaseClient = supabase.createClient(
      'https://brzsayjqohyhpssfgqct.supabase.co',
      'Markitho15' // ⚠️ Recuerda que en producción debe ser solo tu clave pública
    );

    let usuarioActual = null;
    let rolUsuario = null;

    async function verificarSesion() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (user) {
        const { data, error } = await supabaseClient.from('usuarios').select('rol').eq('email', user.email).single();
        if (!error) {
          usuarioActual = user;
          rolUsuario = data.rol;
        }
      }
    }

    async function cargarServicios() {
      const { data: servicios, error } = await supabaseClient
        .from('servicios')
        .select('*')
        .eq('estado', 'aprobado');

      if (error) {
        document.getElementById('servicios-container').innerHTML = '<p>Error al cargar servicios.</p>';
        return;
      }

      const cardsHTML = servicios.map(s => {
        const precio = rolUsuario === 'distribuidor' ? s.precio_distribuidor : s.precio_publico;
        const mostrarPrecio = usuarioActual ? `<p class="card-text fw-bold">Precio: S/ ${precio}</p>` : '';

        return `
          <div class="col-md-4">
            <div class="card h-100 shadow-sm">
              <img src="${s.imagen}" class="card-img-top" alt="${s.titulo}" onerror="this.src='https://via.placeholder.com/300x200'">
              <div class="card-body">
                <h5 class="card-title">${s.titulo}</h5>
                <p class="card-text">${s.descripcion}</p>
                ${mostrarPrecio}
              </div>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('servicios-container').innerHTML = cardsHTML;
    }

    (async () => {
      await verificarSesion();
      await cargarServicios();
    })();
  </script>
</body>
</html>
