<!DOCTYPE html>
<html>
<head>
  <title>Compra de Servicios</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h2>Elegir servicio</h2>
  <p id="creditos">Créditos disponibles: -</p>
  <select id="servicioSelect" onchange="mostrarPrecio()"></select>
  <p id="precioServicio">Precio: -</p>

  <h2>Acciones</h2>
  <button onclick="recargar()">Recargar 10 créditos</button>
  <button onclick="comprar()">Comprar servicio</button>

  <script>
    const supabase = supabase.createClient(
      'https://brzsayjqohyhpssfgqct.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyenNheWpxb2h5aHBzc2ZncWN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwMTU5MzYsImV4cCI6MjA2MDU5MTkzNn0.4JNO1yeUcuSnJXOMN_bZRlugDQZFbkyqYgWyQYkUFF8'
    );

    let servicios = [];

    async function cargarServicios() {
      const { data, error } = await supabase.from('servicios').select('*');
      if (error) {
        console.error('Error al cargar servicios:', error);
        return;
      }
      servicios = data;
      const select = document.getElementById('servicioSelect');
      data.forEach(servicio => {
        const option = document.createElement('option');
        option.value = servicio.id;
        option.textContent = servicio.nombre;
        select.appendChild(option);
      });
    }

    function mostrarPrecio() {
      const selectedId = document.getElementById('servicioSelect').value;
      const servicio = servicios.find(s => s.id == selectedId);
      if (servicio) {
        document.getElementById('precioServicio').innerText = `Precio: ${servicio.precio} créditos`;
      }
    }

    async function recargar() {
      const user = (await supabase.auth.getUser()).data.user;
      if (!user) return alert('No estás autenticado');
      await supabase.from('recargas').insert([{ usuario_id: user.id, cantidad: 10 }]);
      alert('¡Créditos recargados!');
    }

    async function comprar() {
      const user = (await supabase.auth.getUser()).data.user;
      if (!user) return alert('No estás autenticado');

      const servicioId = document.getElementById('servicioSelect').value;
      if (!servicioId) return alert('Selecciona un servicio');

      try {
        await supabase.from('compras').insert([{ cliente_id: user.id, servicio_id: servicioId }]);
        alert('¡Compra realizada!');
      } catch (err) {
        alert('Error al comprar: ' + err.message);
      }
    }

    cargarServicios();
  </script>
</body>
</html>
